# はじめに

# サンプルデータの準備

## サンプルデータのダウンロードとコピー
githubのページを開きます．

![githubのページ](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_214533.png){width=50%}  

`sample_data`に入り，サンプルデータをクリックします．

![サンプルデータ](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_214816.png){width=50%}  

ダウンロードボタンを押してデータをダウンロードします．
4個のサンプルデータをダウンロードしてください．

![サンプルデータのダウンロード](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_215205.png){width=50%}  

ArcGIS Proを開き，新しいプロジェクト`GISDAY2023`を作ります．

![プロジェクトの作成](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_220134.png){width=50%}  

カタログウインドウからフォルダーを開き，GISDAY2023フォルダを右クリックし，ファイルエクスプローラーで表示を選びます．
エクスプローラーでプロジェクタフォルダが開きますので，ダウンロードした4個のファイルをコピーします．

![picture 2](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_131312.png){width=50%}  

ジオプロセッシングウインドウから「JSON→フィーチャ」を選び，入力JSONにプロジェクトフォルダーにコピーしたサンプルデータを指定します．出力フィーチャクラスにGISDAY2023.gdbを指定し，サンプルデータのファイル名を入力します．ジオメトリタイプはポリゴンのままにします．他の3個のサンプルデータも同様にファイルジオデータベースファイルにコピーします．

![picture 3](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_131914.png){width=50%}  

背景地図に地理院タイルの淡色地図を指定します．マップタブのデータの追加からパスからのデータを選び，パスに淡色地図のURLを貼り付けます．

https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png

![picture 4](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132403.png){width=50%}  

# データの作成

## スタート地点とゴール地点の作成

道路ポリゴンの道路部分を選択し，ジオプロセッシングウインドウからランダムポイントの作成を選びます．

![picture 5](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132711.png){width=50%}  

出力場所をGISDAY2023.gdb，出力ポイントフィーチャクラスを`start_points500`，制限フィーチャクラスを`road_polygons`，ポイント数を500，最小距離を1メートルにします．実行すると選択された道路ポリゴン内にランダムなポイント後500個作成されます．

![picture 6](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132941.png){width=50%}  


カタログウインドウのGISDAY2023.gdbを右クリックして新規，フィーチャクラスを選びます．
新しく作成するフィーチャクラスの名前を`goal_points`，フィーチャクラスタイプはポイントにします．次にフィールドを対回鱒．追加するフィールド名は`goal_ID`，データタイプは`Short Integer`にします．作成するポイントデータの空間参照は平面直角座標系第2系（JGD2011）にします．作成するフィーチャクラスの指定が終了したらgoal_pointsのポイントツールを使って，対象範囲に4個のポイントを作成します．

![picture 7](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_133624.png){width=50%} 

![picture 8](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_134134.png){width=50%}  

ポイントを打ったら完了ボタンを押して変更を確定し，保存ボタンを押して変更点を保存します．

![picture 10](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135125.png){width=50%}  

`goal_points`の属性テーブルを開き，属性`goal_ID`に通し番号をつけます．

![picture 9](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_134249.png){width=50%}  

## ラスタファイルの作成

### 道路ラスタの作成

ジオプロセッシングから定数ラスターの作成を選びます．
出力ラスターはGISDAY2023フォルダ内に`road.tif`として作成します．
出力セルサイズは`5`，出力範囲は`aoi`レイヤーに一致させて下さい．
実行するとaoiレイヤーと同じ大きさで値が1のラスターデータが作成されます．

![picture 11](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135453.png){width=50%}  

### コストラスタの作成

road_polygonsの属性テーブルを開き，Short型の属性`road`を追加し，道路部分の値を1，道路以外の値を0にします．

![picture 12](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135855.png){width=50%}

![picture 13](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_140244.png){width=50%}  

road_polygonsの属性テーブルから属性条件で選択を選び，`road`が1のポリゴンのみを選択します．
フィールド演算を用いて選択されたポリゴンの属性`cost`を`1`にします．
選択を反転し，`road`が0のポリゴンの属性`cost`を10にします．

![picture 14](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_140533.png){width=50%}  

ジオプロセッシングから「フィーチャ → ラスタ」を選びます．
入力フィーチャを`road_polygons`，フィールドを`cost`，出力ラスターをgisday2023フォルダの`cost.tif`，出力セルサイズを`5`にして環境タブをクリックします．
スナップ対象ラスタを`road.tif`にして実行します．

![picture 15](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_141129.png){width=50%}  

道路部分が1，道路以外が10の5mメッシュのラスタデータができました．

![picture 16](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_141503.png){width=50%}  

### 加重コスト距離の作成

ジオプロセッシングから「コスト距離」を選びます．
入力ラスター又はフィーチャソースデータに`goal_points`入力コストラスターに`cost.tif`，
出力距離ラスターを`GISDAY2023`フォルダ内に`CostDis.tif`として保存します．
実行すると加重コスト距離ラスターが作成されます．

![picture 17](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152238.png){width=50%}  

![picture 18](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152558.png){width=50%}  

### スタート地点への属性付与

スタート地点データ`start_points500`にShort型の属性`cost_ID`を追加して保存します．
`cost_ID`の値を`0`にします．

![picture 19](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152853.png){width=50%}  

### スタート地点とゴール地点をGeoJSONで書き出す

ジオプロセッシングから「フィーチャ → JSON」を選び，`start_points500`と`goal_points`をそれぞれ`start_points500.geojson`と`goal_points.geojson`で書き出します．
その際に「GeoJSONに出力」にチェックを入れます．

![picture 20](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_153009.png){width=50%}  

# GoogleColaboratoryでのプログラム実行

## GoogleDriveへのデータコピー

GoogleDriveにログインし，`gisday2023`フォルダを作成します．

![picture 21](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162030.png)  

ArcGISのカタログウインドウからプロジェクトフォルダをファイルエクスプローラーで表示します．

![picture 22](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162127.png)  

プログラム実行に必要なファイル（`CostDist.tif`，`goal_points.geojson`，`road.tif`，`start_points500.geojson`）をGoogleDriveの`gisday2023`フォルダにアップロードします．

![picture 23](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162311.png)  

GIS Day in 東京 2023 Eコースのリポジトリに行って`GISDay2023_プログラム.ipynb`をクリックし，プログラムを開きます．
開いたプログラムの一番上にある「Open in Colab」ボタンを押してプログラムをGoogle Colaboratoryで開きます．
GoogleColaboratoryで開いたプログラムは実行できますが，変更したプログラムを保存することができません．
コピーしたプログラムなら変更を保存できるので，Colaboratoryのファイルメニューからコピーを作成しておきます．

![picture 25](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162906.png)  

セルの左側にある実行ボタンを押してそのセルを実行します．
最初に実行したときには警告が出ますので「このまま実行」を押して実行を継続して下さい．

![picture 26](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163302.png)  

途中でプログラムからGoogleDriveにアクセスするための許可が求められます．
「このまま実行」，「GoogleDriveに接続」を押し，接続を許可して下さい．

![picture 27](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163400.png)  

GoogleDriveに接続できると左側のフォルダアイコンでGoogleDriveにアクセスできます．
gisday2023フォルダが見えているか確認し，以降のすべてのセルを順次実行して下さい．

![picture 28](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163552.png)  

プログラムの実行が終了するとGoogleDriveに計算結果のファイル(`test_200_model_vars.csv`と`test_200_agent_vars.gpkg`）ができます．
この2個のファイルをダウンロードしてArcGISのプロジェクトフォルダにコピーしてください．

![picture 29](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163826.png)  

![picture 30](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_164058.png)  

