# はじめに

# サンプルデータの準備

## サンプルデータのダウンロードとコピー
githubのページを開きます．

![githubのページ](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_214533.png)  

`sample_data`に入り，サンプルデータをクリックします．

![サンプルデータ](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_214816.png)  

ダウンロードボタンを押してデータをダウンロードします．
4個のサンプルデータをダウンロードしてください．

![サンプルデータのダウンロード](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_215205.png)  

ArcGIS Proを開き，新しいプロジェクト`GISDAY2023`を作ります．

![プロジェクトの作成](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231113_220134.png)  

カタログウインドウからフォルダーを開き，GISDAY2023フォルダを右クリックし，ファイルエクスプローラーで表示を選びます．
エクスプローラーでプロジェクタフォルダが開きますので，ダウンロードした4個のファイルをコピーします．

![picture 2](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_131312.png)  

ジオプロセッシングウインドウから「JSON→フィーチャ」を選び，入力JSONにプロジェクトフォルダーにコピーしたサンプルデータを指定します．出力フィーチャクラスにGISDAY2023.gdbを指定し，サンプルデータのファイル名を入力します．ジオメトリタイプはポリゴンのままにします．他の3個のサンプルデータも同様にファイルジオデータベースファイルにコピーします．

![picture 3](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_131914.png)  

背景地図に地理院タイルの淡色地図を指定します．マップタブのデータの追加からパスからのデータを選び，パスに淡色地図のURLを貼り付けます．

https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png

![picture 4](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132403.png)  

# データの作成

## スタート地点とゴール地点の作成

道路ポリゴンの道路部分を選択し，ジオプロセッシングウインドウからランダムポイントの作成を選びます．

![picture 5](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132711.png)  

出力場所をGISDAY2023.gdb，出力ポイントフィーチャクラスを`start_points500`，制限フィーチャクラスを`road_polygons`，ポイント数を500，最小距離を1メートルにします．実行すると選択された道路ポリゴン内にランダムなポイント後500個作成されます．

![picture 6](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_132941.png)  


カタログウインドウのGISDAY2023.gdbを右クリックして新規，フィーチャクラスを選びます．
新しく作成するフィーチャクラスの名前を`goal_points`，フィーチャクラスタイプはポイントにします．次にフィールドを対回鱒．追加するフィールド名は`goal_ID`，データタイプは`Short Integer`にします．作成するポイントデータの空間参照は平面直角座標系第2系（JGD2011）にします．作成するフィーチャクラスの指定が終了したらgoal_pointsのポイントツールを使って，対象範囲に4個のポイントを作成します．

![picture 7](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_133624.png) 

![picture 8](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_134134.png)  

ポイントを打ったら完了ボタンを押して変更を確定し，保存ボタンを押して変更点を保存します．

![picture 10](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135125.png)  

`goal_points`の属性テーブルを開き，属性`goal_ID`に通し番号をつけます．

![picture 9](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_134249.png)  

## ラスタファイルの作成

### 道路ラスタの作成

ジオプロセッシングから定数ラスターの作成を選びます．
出力ラスターはGISDAY2023フォルダ内に`road.tif`として作成します．
出力セルサイズは`5`，出力範囲は`aoi`レイヤーに一致させて下さい．
実行するとaoiレイヤーと同じ大きさで値が1のラスターデータが作成されます．

![picture 11](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135453.png)  

### コストラスタの作成

road_polygonsの属性テーブルを開き，Short型の属性`road`を追加し，道路部分の値を1，道路以外の値を0にします．

![picture 12](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_135855.png)

![picture 13](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_140244.png)  

road_polygonsの属性テーブルから属性条件で選択を選び，`road`が1のポリゴンのみを選択します．
フィールド演算を用いて選択されたポリゴンの属性`cost`を`1`にします．
選択を反転し，`road`が0のポリゴンの属性`cost`を10にします．

![picture 14](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_140533.png)  

ジオプロセッシングから「フィーチャ → ラスタ」を選びます．
入力フィーチャを`road_polygons`，フィールドを`cost`，出力ラスターをgisday2023フォルダの`cost.tif`，出力セルサイズを`5`にして環境タブをクリックします．
スナップ対象ラスタを`road.tif`にして実行します．

![picture 15](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_141129.png)  

道路部分が1，道路以外が10の5mメッシュのラスタデータができました．

![picture 16](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_141503.png)  

### 加重コスト距離の作成

ジオプロセッシングから「コスト距離」を選びます．
入力ラスター又はフィーチャソースデータに`goal_points`入力コストラスターに`cost.tif`，
出力距離ラスターを`GISDAY2023`フォルダ内に`CostDis.tif`として保存します．
実行すると加重コスト距離ラスターが作成されます．

![picture 17](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152238.png)  

![picture 18](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152558.png)  

### スタート地点への属性付与

スタート地点データ`start_points500`にShort型の属性`cost_ID`を追加して保存します．
`cost_ID`の値を`0`にします．

![picture 19](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_152853.png)  

### スタート地点とゴール地点をGeoJSONで書き出す

ジオプロセッシングから「フィーチャ → JSON」を選び，`start_points500`と`goal_points`をそれぞれ`start_points500.geojson`と`goal_points.geojson`で書き出します．
その際に「GeoJSONに出力」にチェックを入れます．

![picture 20](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_153009.png)  

# GoogleColaboratoryでのプログラム実行

## GoogleDriveへのデータコピー

GoogleDriveにログインし，`gisday2023`フォルダを作成します．

![picture 21](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162030.png)  

ArcGISのカタログウインドウからプロジェクトフォルダをファイルエクスプローラーで表示します．

![picture 22](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162127.png)  

プログラム実行に必要なファイル（`CostDist.tif`，`goal_points.geojson`，`road.tif`，`start_points500.geojson`）をGoogleDriveの`gisday2023`フォルダにアップロードします．

![picture 23](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162311.png)  

GIS Day in 東京 2023 Eコースのリポジトリに行って`GISDay2023_プログラム.ipynb`をクリックし，プログラムを開きます．
開いたプログラムの一番上にある「Open in Colab」ボタンを押してプログラムをGoogle Colaboratoryで開きます．
GoogleColaboratoryで開いたプログラムは実行できますが，変更したプログラムを保存することができません．
コピーしたプログラムなら変更を保存できるので，Colaboratoryのファイルメニューからコピーを作成しておきます．

![picture 25](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_162906.png)  

セルの左側にある実行ボタンを押してそのセルを実行します．
最初に実行したときには警告が出ますので「このまま実行」を押して実行を継続して下さい．

![picture 26](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163302.png)  

途中でプログラムからGoogleDriveにアクセスするための許可が求められます．
「このまま実行」，「GoogleDriveに接続」を押し，接続を許可して下さい．

![picture 27](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163400.png)  

GoogleDriveに接続できると左側のフォルダアイコンでGoogleDriveにアクセスできます．
gisday2023フォルダが見えているか確認し，以降のすべてのセルを順次実行して下さい．

![picture 28](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163552.png)  

プログラムの実行が終了するとGoogleDriveに計算結果のファイル(`test_200_model_vars.csv`と`test_200_agent_vars.gpkg`）ができます．
この2個のファイルをダウンロードしてArcGISのプロジェクトフォルダにコピーしてください．

![picture 29](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_163826.png)  

ArcGISのカタログウインドウを右クリックして最新の情報に更新すると`test_200_agent_vars.gpkg`が見えるようになります．

![picture 30](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_164058.png)  

# 計算結果の表示

## 時系列データの設定と表示
計算結果をファイルジオデータベースにインポートします．
`GISDAY2023.gdb`を右クリックして複数のフィーチャクラスのインポートを選びます．
入力フィーチャに`test_200_agent_vars.gpkg`の`main_agent_vars`を指定し，出力ジオデータベースが`GISDAY2023.gdb`になっていることを確認して実行ボタンを押します．

![picture 31](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_192252.png)  

インポートが済むと`GISDAY2023.gdb`の中に`main_agent_vars`ができるので，これをマップに読み込ませます．

`main_agent_vars`の属性テーブルを開いて中身を確認します．
属性`step`は計算のステップ数，`AgentID`はエージェントの識別子です．
`Pos`はグリッド上のエージェントの座標です．
`Goal`はエージェントがゴール済みかどうかを表す属性で，0はまだゴールしておらず，1はゴール済みです．`Strategy`と`Behavior`は今回は使っていません．
`pop`はエージェント一つ当たりの人数で，今回は一律で1にしてあります．
`start_move`は避難開始までのカウント数で，今回はプログラム内でランダムに1〜50までの値を振っています．
`Time`は2020年1月1日を0:00を起算時刻とした経過時間です．

![picture 32](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_193228.png)  

次に計算結果の時系列設定を行います．
レイヤ`main_agent_vars`のプロパティから時間を選びます．
「レイヤーの時間」は属性`Time`の一つだけなので，`各フィーチャに1つの時間フィールドがあります`を選びます．
「時間フィールド」には属性`Time`を指定し，「時間間隔」は`事前定義の時間間隔なし`です．
これでOKを押します．

![picture 33](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_193316.png)  

メインメニューの「時間」を押し，左側の時間表示ボタンをオンにします．
時間の「間隔」を`5秒`に設定し，鍵マークを押して間隔を固定します．
また，「終了の除外」をオンにします．
これで開始時刻の「202/01/01 0:00:00」以降「2020/1/1 0:00:05」より前の状態がマップに表示されます．
マップ上部のスライドバーや【再生」ボタンで，設定した時間間隔ごとのアニメーション表示ができます．

![picture 35](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_194011.png)  

## ヒートマップの表示

`main_agent-vars`レイヤを右クリックしてコピーし，マップに貼り付けて複製します．
`main_agent_vars`片方を右クリックして`シンボル`を表示し，プライマリシンボルを「ヒートマップ」にすれば，エージェント密度によるヒートマップが表示されます．

![picture 36](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_194920.png)  

# アニメーションの出力

「表示」メニューからアニメーションの「追加」を押すご，画面下部にアニメーションタイムラインが表示されます．
アニメーションタイムラインの「最初のキーフレームの追加」を押すと，最初の時刻がキーフレームに追加されます．

![picture 37](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_200657.png)  

「アニメーション」メニューの「インポート」から「タイムスライダーのステップ」を選ぶと，
すべてのタイムステップがタイムラインに追加されます．

![picture 38](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_201312.png)  

`control-A`キーを押してタイムラインのすべてのキーフレームを選択し，
右クリックから「アニメーションプロパティ」を選びます．

![picture 39](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_201515.png) 

「アニメーションプロパティ」の「長さ」を0.1秒にし，1タイムステップ当たりの表示時間を0.1秒にします．

![picture 40](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_201722.png)  

まずは「ドラフト」の設定を選び，アニメーションの保存先とファイル名を指定します・
メディア型式は`MPEG4ムービー (.mp4)`当たりにして，1秒あたりのフレーム数を`10`にします．
エクスポートボタンを押すとアニメーションの作成が始まります．
完成までには数分かかりますが，できあがったものを確認して問題がなければ
解像度の高い（HD1080など）アニメーションも作成しましょう．

![picture 42](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231116_202140.png)  

# 一歩進んだシミュレーションを行う

## テスト用にエージェント数を減らす


```python
# これを
start_location = gpd.read_file(base_dir + start_geojson).explode(index_parts = True)\
  .cx[ULX+Xsize: ULX + ((cost_file.RasterXSize - 1) * Xsize)\
  , ULY + ((cost_file.RasterYSize + 1) * Ysize): ULY + Ysize]
```

に`.sample(200)`を加えます．

```python
# このように変更します．
start_location = gpd.read_file(base_dir + start_geojson).explode(index_parts = True)\
  .cx[ULX+Xsize: ULX + ((cost_file.RasterXSize - 1) * Xsize)\
  , ULY + ((cost_file.RasterYSize + 1) * Ysize): ULY + Ysize]\
  .sample(200)
```

## 計算ステップ数を変える

`runstep`の数を変えます．

```python
# 実行するステップ数を指定する
# テストなら200ステップくらいが妥当か
runstep = 200
```

```python
# 実行するステップ数を指定する
# テストなら200ステップくらいが妥当か
runstep = 500
```

## エージェントごとに行動パターンを変える

エージェントはコスト距離に従って移動します．
本プログラムは複数のコスト距離に対応しているので，
必要なだけコスト距離を作成してプログラムに読み込ませます．
例えばコスト距離のデータが4個（`CostDis0.tif`，`CostDis1.tif`，`CostDis2.tif`，`CostDis3.tif`）あった場合，
プログラム中でコスト距離のファイルを指定している部分を変更します．

```python
# これを
cost_files = ['CostDis.tif']
```

```python
# このように変更します
cost_files = [`CostDis0.tif`, `CostDist1.tif`, `CostDist2.tif`, `CostDist3.tif`]
```

エージェントがどのコスト距離を参照するかはエージェントの属性`cost_ID`に従います．
属性`cost_ID`にはコスト距離リストのインデックスを指定します．
前述の例だと，`CostDist0.tif`に従う場合は`0`を，`CostDis2.tif`に従う場合は`1`にします．

試しに複数のコスト距離を作成してみましょう．
ゴール地点の一つを選択し，ジオプロセッシングからコスト距離を選びます．
「入力ラスターまたはフィーチャソースデータ」に`goal_points`を選びます．
`goal_points`のうちの一つが選択されているので，「入力に選択が含まれています．処理するレコード: 1」と表示され，コスト距離の処理点としてゴールの1点のみが指定されていることがわかります．
この状態でコスト距離を作成すると，選択されているゴールまでのコスト距離が生成されます．
他のゴール点についても同様にコスト距離を作成し，出力するファイル名を`CostDis0.tif`，`CostDis1.tif`，`CostDis2.tif`，`CostDis3.tif`とします．

![picture 43](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231117_110140.png)  

次に`start_points500`に`Short`型の属性`cost_ID`を追加します．
続いてスタート点ごとに`cost_ID`の値を設定します．
コスト距離のファイルは新たに作成した4個を使うので，`cost_ID`の値は`0`から`3`までを入れます．
ここではランダムに`0`から`3`までの値を入れます．

フィールド演算を開き，入力テーブルを`stasrt_point500`，フィールド名を`cost_ID`にし，
式に`Random()*3`と入力します．これで`cost_ID`は0から3までの整数が入ります．

![picture 44](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231117_110840.png)  

`cost_ID`が設定できたら，`start_points500`をGeoJSONで書き出します．
ここでは`start_points500_2.geojson`として書き出しました．

![picture 45](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231117_111544.png)  

新たに作成したコスト距離（`CostDis0.tif`，`CostDis1.tif`，`CostDis2.tif`，`CostDis3.tif`）とスタート地点のGeoJSON（`start_points500_2.geojson`）をGoogle Driveの`gisday2023`フォルダにアップロードします．

![picture 46](images/GISDay2023_%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88/20231117_111901.png)  

次にプログラムを修正します．

「データファイルの指定」セルのコスト距離の指定の部分を変更します．

```python
# これを
cost_files = ['CostDis.tif']
```

```python
# このように変更します
cost_files = [`CostDis0.tif`, `CostDist1.tif`, `CostDist2.tif`, `CostDist3.tif`]
```

また，スタート地点の指定も変更します．

```python
# これを
start_geojson = 'start_points500.geojson'
```

```python
# このように変更します
start_geojson = 'start_points500_2.geojson'
```


## 通行不可能な場所を設定する



## 

